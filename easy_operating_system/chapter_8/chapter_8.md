# Ch.08 가상 메모리의 기초

## 01. 가상 메모리의 개요

- 가상메모리란?
  : 물리 메모리의 크기와 상관없이 프로세스에 커다란 메모리 공간을 제공하는 기술이다.

- 가상 메모리의 특징

  - 가상 메모리 시스템에서 모든 프로세스는 메모리의 어느 위치에 있는지 상관없이 0번부터 시작하는 연속된 메모리 공간을 가진다.
  - 가상 메모리의 크기는 무한대지만, 실제로 가상 메모리의 최대 크기는 컴퓨터 시스템이 가진 물리 메모리의 최대 크기로 한정된다. (스왑을 이용하면 실제 사용할 수 있는 물리 메모리의 크기를 넘어서 무한대로 메모리를 사용할 수 있다.)

    - 스왑영역이란?
      :하드디스크에 존재하지만 메모리 관리자가 관리하는 영역으로서 메모리의 일부이며, 가상 메모리의 구성 요소 중 하나다.

    - 동적 주소 변환이란?
      : 가상 메모리 시스템에서 메모리 관리자가 물리 메모리와 스왑영역을 합쳐서 프로세스가 사용하는 가상 주소를 실제 메모리의 물리 주소로 변환하는 과정

- 매핑 테이블이란?
  : 가상 주소는 실제로 물리 주소나 스왑 영역 중 한곳에 위치하는데, 메모리 관리자가 가상주소와 물리 주소를 일대일로 매핑한 테이블로 관리하게 되며, 이를 매핑 테이블 이라고 하는데, 매핑 테이블은 가상 주소가 물리 메모리의 어느 위치에 있는지 알 수 있게 해준다.
  (ex) 페이지 매핑 테이블, 세그멘테이션 매핑 테이블

- 지역성이란?
  : 국부성 또는 집약성 이라고도 하며, 기억장치에 접근하는 패턴이 메모리 전체에 고루 분포되는 것이 아니라 특정 영역에 집중되는 성질을 말한다.

  1. 공간의 지역성
     : 현재 위치에서 가까운 데이터에 접근할 확률이 먼 거리에 있는 데이터레 접근할 확률보다 높음을 의미한다.

  2. 시간의 지역성
     : 현재를 기준으로 가장 가까운 시간에 접근한 데이터가 더 먼 시간에 접근한 데이터보다 사용될 확률이 높음을 의미한다.

  3. 순차적 지역성
     : 작업이 순서대로 진행되는 것을 의미한다.

  (ex) 캐시, 페이지 교체 알고리즘

## 02. 페이징 기법

: 고정 분할 방식을 이용한 가상 메모리 관리 기법으로, 물리 주소 공간을 같은 크기로 나누어 사용한다.

- 페이지
  : 가상 주소의 분할된 각 영역을 페이지 라고 부른다.

- 프레임
  : 물리 메모리의 각 영역은 가상 주소의 페이지와 구분하기 위해 프레임 이라고 부른다.

  => 프레임과 페이지의 크기는 같으며, 각 영역들은 0 부터 시작하여 1씩 커진다.

- 페이지 테이블
  : 어떤 페이지가 어떤 프레임에 있는지에 대한 연결(매핑) 정보는 페이지 테이블에 담겨 있다.
  하나의 열로 구성되며, 각 열에 담긴 숫자는 프레임의 번호를 의미한다.
  (보통 행 번호는 0부터 시작하며, 페이지의 번호를 의미한다.
  페이지 번호는 보통 생략이 되지만, 페이지 테이블 엔트리에 페이지 테이블 번호와 프레임 번호가 함께 표시되어 있다면 페이지 번호가 순서대로 저장되지 않은 경우다.)

  - 각각의 한줄을 "페이지 테이블 엔트리" 라고 부른다.
  - 페이지 테이블의 크기는 물리 주소의 크기가 아니라 프로세스의 크기에 비례한다.

- 가상 주소 VA = <P(페이지),D(페이지의 처음 위치에서 해당 주소까지의 거리)>
- 물리 주소 PA = <F(프레임),D(프레임의 처음 위치에서 해당 주소까지의 거리)>

- 페이지 테이블 관리

  1. 메모리 공유
     : 페이지 테이블은 메모리 관리자가 자주 사용하는 자료구조이므로 필요시 빨리 접근할 수 있어야 한다. 따라서 페이지 테이블은 물리 메모리 영역 중 운영체제 영역의 일부분에 모아놓는다.

  한번에 실행하는 프로세스의 수가 많으면 페이지 테이블의 크기가 같이 커지고, 그에 따라 프로세스가 실제로 사용할 수 있는 메모리 영역이 줄어든다 => 물리 메모리 크기가 작을 때는 프로세스만 스왑영역으로 옮겨지는 것이 아니라 페이지 테이블의 일부도 스왑영역으로 옮겨진다.

  2. 쓰기시점 복사
     : 데이터 변화가 있을 때까지 복사를 미루는 방식

  3. 변환색인 버퍼
     : 가상 주소를 물리 주소로 변환하려면 메모리에 두번 접근해야하는데, 시간이 오리걸리므로, 이는 CPU성능을 떨어뜨린다. => 이를 개선하기위에 변환색인 버퍼를 사용한다.
     이때 페이지 테이블의 일부를 CPU 안쪽으로 가져오는데, 이를 변환색인 버퍼라고 하며, 변환색인 버퍼는 캐시된 페이지 테이블이며 지역성 이론에 근거하여 현재 사용중이거나 사용이 예상되는 페이지 테이블의 일부를 CPU안쪽에 가져온다.

  4. 역 페이지 테이블
     : 기존 페이징 방식과는 반대로 페이지 테이블을 구성한 방식으로, 물리 메모리의 프레임 번호를 기준으로 테이블을 구성하는 것으로 물리 메모리의 프레임에 어떤 프로세스의 어떤 페이지가 올라와 있는지를 표시한다.

     - 장점: 테이블의 크기가 작다.
     - 단점: 프로세스가 물리 메모리에 접근할 때 프로세스 아이디와 페이지 번호를 모두 찾아야 한다.

  5. 다단계 페이지 테이블
     : 주소 공간이 늘어나 페이지 테이블의 크기가 늘어나면 한꺼번에 관리하기가 힘들기 때문에 생겨난 방식으로, 일정 크기로 자를 페이지 테이블의 바깥쪽에 이를 관리하는 새로운 테이블의 만드는 방식
     - 장점: 크기가 큰 페이지 테이블을 같은 크기의 묶음으로 나누어서 효율적으로 관리할 수 있다.

## 03. 세그먼테이션 기법

: 가변 분할 방식을 이용한 가상 메모리 관리 기법으로, 물리 메모리를 프로세스 크기에 따라 가변적으로 나누어 사용한다.

- 세그먼테이션 테이블 or 세그먼테이션 매핑 테이블
  : 세그멘테이션 기법에서 가상 주소가 물리 주소로 변환되는데 사용되는 테이블

  - 보통 2열로 이루어져 있으며, limit(세그먼트의 크기), address(물리 메모리의 시작 주소)를 가진다.
  - 물리 메모리가 부적할 떄, 스왑 영역을 사용한다.

  - 장점: 메모리를 프로세스 단위로 관리하기 때문에 세그먼테이션 테이블이 작고 단순하다.
  - 단점: 물리 메모리의 외부 단편화로 인해 관리가 복잡하다.

- 가상 주소 VA = <S(세그먼트 번호), D(세그먼트 시작 지점에서 해당 주소까지의 거리)>
  - D는 메모리 보호의 의미를 담고 있기도 하다. (트랩: 자신의 영역을 벗어나는주소에 접근하거나 숫자를 0으로 나누는 것과 같이 사용자가 의도치 않게 일으키는 인터럽트를 말한다.)

## 04. 캐시 매핑 기법

: 메모리의 페이징 방식과 마찬가지로 캐시도 메모리를 일정 크기로 나누며 일정 크기로 나눈 덩어리를 페이지 P라고 한다.

    - 메모리는 N개의 페이지로, 캐시는 M개의 페이지로 구성된다고 하면 캐시는 메모리보다 작기 때문에 (N >> M)
    - 블록: N / M

    - 태그(tag): 캐시에 명시하는 블록 번호

- 캐시 직접 매핑
  : 메모리 페이지가 캐시의 같은 위치에 올라오기 때문에 태그만 확인하면 캐시 히트나 캐시 미스를 빠르게 확인할 수 있다. 그러나 페이지가 같은 위치에만 올라오기 때문에 자리다툼이 발생한다.

- 캐시 연관 매핑
  : 캐시 메모리를 자유롭개 사용할 수 있는 것이 장점이다. 그러나 캐시 히트인지 캐시 미스인지 확인하기 위해 캐시의 모든 주소를 검색해야 한다는 단점도 있다. 따라서 캐시 연관 매핑은 캐시 직접 매핑보다 느리다.

- 캐시 집합-연관 매핑
  : 캐시 직접 매핑과 캐시 연관 매핑의 장점만 취한 방식이다. 캐시를 K개 집합으로 나누고 각 집합에 캐시 직접 매핑을 사용하여 캐시 직접 매핑의 자리다툼 문제가 완화된다.
